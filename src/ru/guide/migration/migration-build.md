# Сборка для миграции

## Обзор

`@vue/compat` (она же «сборка для миграции») — специальная сборка Vue 3, поведение которой можно настраивать для совместимости с Vue 2.

Сборка для миграции по умолчанию работает в режиме Vue 2 — большая часть публичных API ведёт себя точно также, как и во Vue 2, за несколькими исключениями. Использование возможностей, которые претерпели изменения или объявлены устаревшими во Vue 3, будут выбрасывать предупреждения во время выполнения. Также есть возможность включать и выключать на уровне компонента совместимость с определёнными возможностями.

### Предполагаемые сценарии использования

- Обновление приложения Vue 2 на Vue 3 (с некоторыми [ограничениями](#известные-ограничения))
- Миграция библиотеки для поддержки Vue 3
- Для опытных разработчиков Vue 2, которые ещё не пробовали Vue 3, сборка для миграции может помочь в изучении различий между версиями.

### Известные ограничения

Несмотря на то, что сборка для миграции реализовывалась максимально похожей поведением на Vue 2, есть некоторые ограничения, которые могут препятствовать обновлению приложения:

- Зависимости, полагающиеся на внутренние API Vue 2 или недокументированное поведение. Наиболее частым случаем является использование приватных свойств на `VNodes`. Если проект полагается на библиотеки компонентов, такие как [Vuetify](https://vuetifyjs.com/en/), [Quasar](https://quasar.dev/) или [ElementUI](https://element.eleme.io/#/en-US), то сначала лучше дождаться их новых версий, совместимых с Vue 3.

- Поддержка Internet Explorer 11: [Vue 3 официально отказался от поддержки IE11](https://github.com/vuejs/rfcs/blob/master/active-rfcs/0038-vue3-ie11-support.md). При необходимости поддерживать IE11 или ниже придётся остаться на Vue 2.

- Отрисовка на стороне сервера (SSR): сборку для миграции можно использовать для SSR, но миграция пользовательской конфигурации SSR задача намного сложнее. В общем, идея заключается в замене `vue-server-renderer` на [`@vue/server-renderer`](https://github.com/vuejs/vue-next/tree/master/packages/server-renderer). Vue 3 больше не предоставляет bundle renderer и рекомендуется использовать Vue 3 SSR с [Vite](https://vitejs.dev/guide/ssr.html). Если в проекте используется [Nuxt.js](https://nuxtjs.org/), то лучше дождаться Nuxt 3.

### Ожидания

Обратите внимание, сборка для миграции нацелена лишь на публично документированные API и поведение Vue 2. Если приложение не будет работать со сборкой для миграции из-за использования недокументированного поведения, маловероятно, что изменим сборку для миграции, чтобы удовлетворить подобный конкретный случай. Вместо этого рассмотрите возможность рефакторинга, чтобы избавиться от данного нестандартного поведения.

Предостережение: для большого и сложного приложения миграция, скорее всего, будет сложной даже со сборкой для миграции. Если приложение не подходит для обновления, обратите внимание, что планируется портировать Composition API и некоторые другие функции Vue 3 в релизе 2.7 (предположительно в конце третьего квартала 2021).

Если приложение на сборке для миграции удалось запустить, то его **можно опубликовать в production** до завершения процесса миграции. Несмотря на небольшие накладные расходы по производительности/размеру, это не должно заметно повлиять на UX в production. Такое может потребоваться, если есть зависимости, которые зависят от поведения Vue 2, и не могут быть обновлены/заменены.

Сборка для миграции выпускается, начиная с версии 3.1, и будет продолжать обновляться вместе с релизами 3.2. Публикация обновлений сборки для миграции будет прекращена в одной из будущих минорных версий (не ранее конца 2021 года), поэтому до этого времени стоит запланировать переход на стандартную сборку.

## Процесс обновления

Следующий процесс обновления описывает шаги по миграции фактического приложения на Vue 2 (Vue HackerNews 2.0) до Vue 3. Полный список коммитов можно найти [здесь](https://github.com/vuejs/vue-hackernews-2.0/compare/migration). Обратите внимание, что для собственного проекта фактические шаги могут отличаться. Описанную здесь последовательность следует рассматривать как общее руководство к действию, а не как строгую инструкцию.

### Подготовка

- При использовании [устаревшего синтаксиса именованных слотов / слотов с ограниченной областью видимости](https://ru.vuejs.org/v2/guide/components-slots.html#%D0%A3%D1%81%D1%82%D0%B0%D1%80%D0%B5%D0%B2%D1%88%D0%B8%D0%B9-%D1%81%D0%B8%D0%BD%D1%82%D0%B0%D0%BA%D1%81%D0%B8%D1%81), обновите его сначала до нового синтаксиса (который уже поддерживается в версии 2.6).

### Установка

1. Обновите инструментарий, при возможности.

   - При использовании пользовательской конфигурации webpack: обновите `vue-loader` до версии `^16.0.0`.
   - При использовании `vue-cli`: обновите `@vue/cli-service` до последней версии с помощью команды `vue upgrade`
   - (Альтернатива) Мигрируйте на [Vite](https://vitejs.dev/) + [vite-plugin-vue2](https://github.com/underfin/vite-plugin-vue2). [[Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/565b948919eb58f22a32afca7e321b490cb3b074)]

2. В файле `package.json`, обновите `vue` до 3.1. Установите `@vue/compat` такой же версии и замените `vue-template-compiler` (если присутствует) на `@vue/compiler-sfc`:

    ```diff
    "dependencies": {
    -  "vue": "^2.6.12",
    +  "vue": "^3.1.0",
    +  "@vue/compat": "^3.1.0"
        ...
    },
    "devDependencies": {
    -  "vue-template-compiler": "^2.6.12"
    +  "@vue/compiler-sfc": "^3.1.0"
    }
    ```

   [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/14f6f1879b43f8610add60342661bf915f5c4b20)

3. В конфигурации сборки установите псевдоним для `vue` на `@vue/compat` и включите режим совместимости сборки для миграции через опции компилятора Vue.

    **Примеры конфигураций**

    <details>
      <summary><b>vue-cli</b></summary>

    ```js
    // vue.config.js
    module.exports = {
      chainWebpack: config => {
        config.resolve.alias.set('vue', '@vue/compat')

        config.module
          .rule('vue')
          .use('vue-loader')
          .tap(options => {
            return {
              ...options,
              compilerOptions: {
                compatConfig: {
                  MODE: 2
                }
              }
            }
          })
      }
    }
    ```

    </details>

    <details>
      <summary><b>Чистый webpack</b></summary>

    ```js
    // webpack.config.js
    module.exports = {
      resolve: {
        alias: {
          vue: '@vue/compat'
        }
      },
      module: {
        rules: [
          {
            test: /\.vue$/,
            loader: 'vue-loader',
            options: {
              compilerOptions: {
                compatConfig: {
                  MODE: 2
                }
              }
            }
          }
        ]
      }
    }
    ```

    </details>

    <details>
      <summary><b>Vite</b></summary>

    ```js
    // vite.config.js
    export default {
      resolve: {
        alias: {
          vue: '@vue/compat'
        }
      },
      plugins: [
        vue({
          template: {
            compilerOptions: {
              compatConfig: {
                MODE: 2
              }
            }
          }
        })
      ]
    }
    ```

    </details>

4. При использовании TypeScript нужно изменить типизацию `vue` для объявления экспорта по умолчанию (которого больше нет во Vue 3), добавив `*.d.ts` следующего вида:

    ```ts
    declare module 'vue' {
      import { CompatVue } from '@vue/runtime-dom'
      const Vue: CompatVue
      export default Vue
      export * from '@vue/runtime-dom'
    }
    ```

5. На данном этапе приложение может столкнуться с ошибками / предупреждениями на этапе компиляции (например, при использовании фильтров). Исправьте их в первую очередь. После того как все предупреждения компилятора будут исправлены, можно переключить компилятор в режим Vue 3.

   [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/b05d9555f6e115dea7016d7e5a1a80e8f825be52)

6. После исправления ошибок приложение должно запускаться, если его не затрагивают [известные ограничения](#известные-ограничения), перечисленные выше.

   Скорее всего увидите МНОЖЕСТВО предупреждений, как в командной строке, так и в консоли браузера. Вот несколько общих советов:

   - Можно отфильтровать конкретные предупреждения в консоли браузера. Хорошая идея — воспользоваться фильтром и сосредоточиться на исправлении одного типа ошибки за раз. Также можно использовать отрицание в фильтрах, например `-GLOBAL_MOUNT`.

   - Можно отключить вывод предупреждений о конкретных ошибках через [конфигурацию совместимости](#конфигурация-совместимости).

   - Некоторые предупреждения могут быть вызваны используемой зависимостью (например, `vue-router`). Проверить это можно по трассировке предупреждения компонента или трассировке стека (разворачивается по клику). Для начала лучше сосредоточиться на исправлении предупреждений в собственном исходным коде.

   - Если используете `vue-router`, обратите внимание, что `<transition>` и `<keep-alive>` не будут работать с `<router-view>` пока не обновите `vue-router` до версии v4.

7. Обновите [имена классов `<transition>`](transition.md). Это единственная функция, которая не имеет предупреждения во время выполнения. Можно выполнить поиск по всему проекту для имён CSS-классов `.*-enter` и `.*-leave`.

   [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/d300103ba622ae26ac26a82cd688e0f70b6c1d8f)

8. Обновите точку входа приложения на использование [нового глобального API монтирования](global-api.md#новыи-глобальныи-api-createapp).

   [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/a6e0c9ac7b1f4131908a4b1e43641f608593f714)

9. [Обновите `vuex` до версии v4](https://next.vuex.vuejs.org/guide/migrating-to-4-0-from-3-x.html).

   [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/5bfd4c61ee50f358cd5daebaa584f2c3f91e0205)

10. [Обновите `vue-router` до версии v4](https://next.router.vuejs.org/guide/migration/index.html). Если также используется `vuex-router-sync`, то можно его заменить на геттер.

    После обновления, для использования `<transition>` и `<keep-alive>` совместно с `<router-view>` необходимо воспользоваться новым [синтаксисом слотов с ограниченной областью видимости](https://next.router.vuejs.org/guide/migration/index.html#router-view-keep-alive-and-transition).

    [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/758961e73ac4089890079d4ce14996741cf9344b)

11. Выбирайте отдельные предупреждения и исправляйте их. Обратите внимание, что некоторые функции имеют несовместимое поведение между Vue 2 и Vue 3 — например, API render-функций или изменения функциональных компонентов vs. асинхронных компонентов. Чтобы выполнять миграцию на API Vue 3, не затрагивая остальные части приложения, можно определять поведение Vue 3 для конкретного компонента через [опцию `compatConfig`](#конфигурация-для-компонента).

    [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/d0c7d3ae789be71b8fd56ce79cb4cb1f921f893b)

12. После исправления всех предупреждений можно удалить сборку для миграции и перейти на обычную сборку Vue 3. Обратите внимание, что это нельзя будет сделать, если есть зависимости, которые полагаются на поведение Vue 2.

    [Пример коммита](https://github.com/vuejs/vue-hackernews-2.0/commit/9beb45490bc5f938c9e87b4ac1357cfb799565bd)

## Конфигурация совместимости

### Глобальная конфигурация

Совместимость с возможностями можно отключать по-отдельности:

```js
import { configureCompat } from 'vue'

// отключение совместимости для отдельных возможностей
configureCompat({
  FEATURE_ID_A: false,
  FEATURE_ID_B: false
})
```

В качестве альтернативы, всё приложение может по умолчанию использовать поведение Vue 3, включая совместимость лишь для определённых возможностей:

```js
import { configureCompat } from 'vue'

// по умолчанию всё поведение как во Vue 3, и только
// включение совместимости для определённых возможностей
configureCompat({
  MODE: 3,
  FEATURE_ID_A: true,
  FEATURE_ID_B: true
})
```

### Конфигурация для компонента

В компоненте можно использовать опцию `compatConfig`, которая ожидает такие же параметры, что и глобальный метод `configureCompat`:

```js
export default {
  compatConfig: {
    MODE: 3, // выбор поведения Vue 3 для этого компонента
    FEATURE_ID_A: true // возможностями можно управлять на уровне компонента
  }
  // ...
}
```

### Конфигурация компиляции

Возможности, названные с `COMPILER_`, специфичны для компилятора: при использовании полной сборки (с компиляцией шаблонов в браузере), они могут быть настроены во время выполнения. Однако при использовании шага сборки их нужно настраивать через опцию `compilerOptions` в конфигурации сборки (см. примеры конфигураций выше).

## Перечень возможностей

### Типы совместимости

- ✔ Полная совместимость
- ◐ Частичная совместимость (с ограничениями)
- ⨂ Нет совместимости (только предупреждения)
- ⭘ Только для совместимости (нет предупреждений)

### Нет совместимости

> Требуется исправить заранее или может приводить к ошибкам

| ID                                    | Тип | Описание                                                                          | Документация                                                                                     |
|---------------------------------------|-----|-----------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------|
| GLOBAL_MOUNT_CONTAINER                | ⨂   | Монтируемое приложение не заменяет элемент, к которому монтируется                | [ссылка](mount-changes.md)                                                                       |
| CONFIG_DEVTOOLS                       | ⨂   | devtools в production теперь определяется флагом при сборке                       | [ссылка](https://github.com/vuejs/vue-next/tree/master/packages/vue#bundler-build-feature-flags) |
| COMPILER_V_IF_V_FOR_PRECEDENCE        | ⨂   | приоритет `v-if` и `v-for` при использовании на одном и том же элементе изменился | [ссылка](v-if-v-for.md)                                                                          |
| COMPILER_V_IF_SAME_KEY                | ⨂   | ветви `v-if` больше не могут иметь одинаковый key                                 | [ссылка](key-attribute.md#использование-на-ветках-с-условием)                                    |
| COMPILER_V_FOR_TEMPLATE_KEY_PLACEMENT | ⨂   | для `<template v-for>` указывать key теперь нужно на `<template>`                 | [ссылка](key-attribute.md#использование-с-template-v-for)                                        |
| COMPILER_SFC_FUNCTIONAL               | ⨂   | `<template functional>` больше не поддерживается в однофайловых компонентах       | [ссылка](functional-components.md#однофаиловые-компоненты-sfc)                                   |

### Частичная совместимость (с ограничениями)

| ID                       | Тип | Описание                                                                                                                                                                                                                                    | Документация                                                                                          |
|--------------------------|-----|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|-------------------------------------------------------------------------------------------------------|
| CONFIG_IGNORED_ELEMENTS  | ◐   | `config.ignoredElements` теперь является `config.compilerOptions.isCustomElement` (только в сборке с компилятором в браузере). При использовании шага сборки, `isCustomElement` должен передаваться через конфигурацию сборки.              | [ссылка](global-api.md#своиство-config-ignoredelements-теперь-config-compileroptions-iscustomelement) |
| COMPILER_INLINE_TEMPLATE | ◐   | `inline-template` удалён (поддерживается только совместимость в сборке с компилятором шаблонов\)                                                                                                                                            | [ссылка](inline-template-attribute.md)                                                                |
| PROPS_DEFAULT_THIS       | ◐   | фабрика значения по умолчанию входного параметра больше не имеет доступа к `this` (в режиме совместимости `this` не является реальным экземпляром — он только предоставляет доступ к входным параметрам, `$options` и внедрённым свойствам) | [ссылка](props-default-this.md)                                                                       |
| INSTANCE_DESTROY         | ◐   | удалён метод экземпляра `$destroy` (в режиме совместимости поддерживается только для корневого экземпляра)                                                                                                                                  |                                                                                                       |
| GLOBAL_PRIVATE_UTIL      | ◐   | `Vue.util` является приватным и больше недоступно                                                                                                                                                                                           |                                                                                                       |
| CONFIG_PRODUCTION_TIP    | ◐   | `config.productionTip` больше не нужен                                                                                                                                                                                                      | [ссылка](global-api.md#удалено-своиство-config-productiontip)                                         |
| CONFIG_SILENT            | ◐   | `config.silent` удалён                                                                                                                                                                                                                      |                                                                                                       |

### Только для совместимости (нет предупреждений)

| ID                 | Тип | Описание                              | Документация            |
|--------------------|-----|---------------------------------------|-------------------------|
| TRANSITION_CLASSES | ⭘   | Изменены классы переходов enter/leave | [ссылка](transition.md) |

### Полная совместимость

| ID                           | Тип | Описание                                                                         | Документация                                                                       |
|------------------------------|-----|----------------------------------------------------------------------------------|------------------------------------------------------------------------------------|
| GLOBAL_MOUNT                 | ✔   | new Vue() -> createApp                                                           | [ссылка](global-api.md#монтирование-экземпляра-приложения)                         |
| GLOBAL_EXTEND                | ✔   | Vue.extend удалён (используйте `defineComponent` или опцию `extends`)            | [ссылка](global-api.md#удален-метод-vue-extend)                                    |
| GLOBAL_PROTOTYPE             | ✔   | `Vue.prototype` -> `app.config.globalProperties`                                 | [ссылка](global-api.md#своиство-vue-prototype-заменено-на-config-globalproperties) |
| GLOBAL_SET                   | ✔   | `Vue.set` удалён (больше не нужен)                                               |                                                                                    |
| GLOBAL_DELETE                | ✔   | `Vue.delete` удалён (больше не нужен)                                            |                                                                                    |
| GLOBAL_OBSERVABLE            | ✔   | `Vue.observable` удалён (используйте `reactive`)                                 | [ссылка](../../api/basic-reactivity.md)                                            |
| CONFIG_KEY_CODES             | ✔   | config.keyCodes удалён                                                           | [ссылка](keycode-modifiers.md)                                                     |
| CONFIG_WHITESPACE            | ✔   | Во Vue 3 пробельные символы по умолчанию `"condense"`                            |                                                                                    |
| INSTANCE_SET                 | ✔   | `vm.$set` удалён (больше не нужен)                                               |                                                                                    |
| INSTANCE_DELETE              | ✔   | `vm.$delete` удалён (больше не нужен)                                            |                                                                                    |
| INSTANCE_EVENT_EMITTER       | ✔   | `vm.$on`, `vm.$off`, `vm.$once` удалены                                          | [ссылка](events-api.md)                                                            |
| INSTANCE_EVENT_HOOKS         | ✔   | Экземпляр больше не генерирует события `hook:x`                                  | [ссылка](vnode-lifecycle-events.md)                                                |
| INSTANCE_CHILDREN            | ✔   | `vm.$children` удалён                                                            | [ссылка](children.md)                                                              |
| INSTANCE_LISTENERS           | ✔   | `vm.$listeners` удалён                                                           | [ссылка](listeners-removed.md)                                                     |
| INSTANCE_SCOPED_SLOTS        | ✔   | `vm.$scopedSlots` удалён; `vm.$slots` теперь предоставляет доступ к функциям     | [ссылка](slots-unification.md)                                                     |
| INSTANCE_ATTRS_CLASS_STYLE   | ✔   | `$attrs` теперь содержит `class` и `style`                                       | [ссылка](attrs-includes-class-style.md)                                            |
| OPTIONS_DATA_FN              | ✔   | `data` должна быть функцией во всех случаях                                      | [ссылка](data-option.md)                                                           |
| OPTIONS_DATA_MERGE           | ✔   | `data` из примеси или расширения теперь неглубоко объединяются                   | [ссылка](data-option.md)                                                           |
| OPTIONS_BEFORE_DESTROY       | ✔   | `beforeDestroy` -> `beforeUnmount`                                               |                                                                                    |
| OPTIONS_DESTROYED            | ✔   | `destroyed` -> `unmounted`                                                       |                                                                                    |
| WATCH_ARRAY                  | ✔   | Отслеживание массива больше не срабатывает при мутации без deep                  | [ссылка](watch.md)                                                                 |
| V_FOR_REF                    | ✔   | `ref` внутри `v-for` не регистрирует массив refs                                 | [ссылка](array-refs.md)                                                            |
| V_ON_KEYCODE_MODIFIER        | ✔   | `v-on` больше не поддерживает модификаторы keyCode                               | [ссылка](keycode-modifiers.md)                                                     |
| CUSTOM_DIR                   | ✔   | Имена хуков пользовательских директив изменены                                   | [ссылка](custom-directives.md)                                                     |
| ATTR_FALSE_VALUE             | ✔   | Атрибут больше не удаляется при привязке булево значения `false`                 | [ссылка](attribute-coercion.md)                                                    |
| ATTR_ENUMERATED_COERCION     | ✔   | Перечисляемые атрибуты больше не являются особым случаем                         | [ссылка](attribute-coercion.md)                                                    |
| TRANSITION_GROUP_ROOT        | ✔   | `<transition-group>` не отрисовывает корневой элемент по умолчанию               | [ссылка](transition-group.md)                                                      |
| COMPONENT_ASYNC              | ✔   | API асинхронных компонентов изменено (теперь требуется `defineAsyncComponent`)   | [ссылка](async-components.md)                                                      |
| COMPONENT_FUNCTIONAL         | ✔   | API функциональных компонентов изменено (должны быть обычными функциями)         | [ссылка](functional-components.md)                                                 |
| COMPONENT_V_MODEL            | ✔   | Переработана v-model на компонентах                                              | [ссылка](v-model.md)                                                               |
| RENDER_FUNCTION              | ✔   | API render-функций изменено                                                      | [ссылка](render-function-api.md)                                                   |
| FILTERS                      | ✔   | Фильтры удалены (эта опция влияет только на API фильтров во время выполнения)    | [ссылка](filters.md)                                                               |
| COMPILER_IS_ON_ELEMENT       | ✔   | Использование `is` теперь ограничено только `<component>`                        | [ссылка](custom-elements-interop.md)                                               |
| COMPILER_V_BIND_SYNC         | ✔   | `v-bind.sync` заменяется `v-model` с аргументами                                 | [ссылка](v-model.md)                                                               |
| COMPILER_V_BIND_PROP         | ✔   | Удалён модификатор `v-bind.prop`                                                 |                                                                                    |
| COMPILER_V_BIND_OBJECT_ORDER | ✔   | `v-bind="object"` is now order sensitive                                         | [ссылка](v-bind.md)                                                                |
| COMPILER_V_ON_NATIVE         | ✔   | Удалён модификатор `v-on.native`                                                 | [ссылка](v-on-native-modifier-removed.md)                                          |
| COMPILER_V_FOR_REF           | ✔   | `ref` в `v-for` (поддержка компилятора)                                          |                                                                                    |
| COMPILER_NATIVE_TEMPLATE     | ✔   | `<template>` без специальных директив теперь отрисовывается как нативный элемент |                                                                                    |
| COMPILER_FILTERS             | ✔   | Фильтры (поддержка компилятора)                                                  |                                                                                    |
